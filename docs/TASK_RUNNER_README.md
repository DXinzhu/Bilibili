# Bilibili 自动测试任务运行器使用说明

## 概述

`task_runner.py` 是一个主调用程序，用于：
- 监控虚拟机操作（通过 ADB logcat）
- 生成包含操作结果的 result 字典
- 调用 tasks 文件夹下的验证函数

## 使用方法

### 1. 交互式运行（推荐）

```bash
python task_runner.py 17
```

这将：
1. 清除旧的 logcat 日志
2. 提示你在虚拟机中完成操作
3. 等待你按回车键
4. 读取日志并验证结果

### 2. 直接提供答案

```bash
python task_runner.py 17 --message "378"
```

这将直接使用提供的消息进行验证，跳过交互式输入。

### 3. 指定设备 ID

```bash
python task_runner.py 17 --device emulator-5554
```

如果有多个设备连接，可以指定设备 ID。

## 参数说明

- `task_number`: 任务编号（必需），例如 17、18、19 等
- `--device` 或 `-d`: 设备 ID（可选）
- `--message` 或 `-m`: 直接提供 final_message（可选）

## 工作流程

1. **清除日志**: 清除旧的 logcat 日志
2. **等待操作**: 提示用户在虚拟机中完成操作
3. **读取日志**: 从 ADB 读取 logcat 日志
4. **生成 result**: 从日志生成 result 字典
5. **调用验证**: 调用 tasks 下的验证函数
6. **输出结果**: 显示验证结果（True/False）

## 注意事项

### 当前限制

`generate_result_from_logs()` 函数目前只是一个框架，需要根据实际情况完善：

```python
def generate_result_from_logs(self, log_content):
    result = {
        "final_message": "",  # 需要从日志中提取
        "log_content": log_content,
        "timestamp": datetime.now().isoformat()
    }
    return result
```

### 如何完善

你需要根据实际的日志格式来实现 `final_message` 的生成逻辑。例如：

```python
# 示例：从日志中提取点赞数
import re
match = re.search(r'LIKE_COUNT: (\d+)', log_content)
if match:
    result["final_message"] = match.group(1)
```

## 输出文件

验证过程中的数据会保存到 `test_results/` 目录：
- `video_comments.json`: 视频评论数据
- `settings.json`: 设置数据
- `logcat.txt`: 日志内容
- 等等...

## 退出码

- `0`: 验证通过
- `1`: 验证失败

## 示例

### 示例 1: 测试任务 17

```bash
python task_runner.py 17
```

输出：
```
============================================================
准备运行任务 17
============================================================

已清除 logcat 日志
请在虚拟机中完成以下操作:
  - 执行任务 17 的相关操作
  - 完成后按回车键继续验证...

按回车键继续...

正在读取日志...

============================================================
运行任务 17
============================================================
⚠️ 无法读取评论数据，回退验证

============================================================
任务 17 验证失败: False
============================================================
```

### 示例 2: 直接提供答案

```bash
python task_runner.py 17 --message "评论区一共有378个赞"
```

输出：
```
============================================================
运行任务 17
============================================================
⚠️ 无法读取评论数据，回退验证

============================================================
任务 17 验证通过: True
============================================================
```
